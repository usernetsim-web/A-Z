<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Игра буква-номер (английский алфавит) с голосом (числа по-русски)</title>
<style>
  body {
    margin: 0; padding: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #eee;
    overflow: hidden;
    height: 100vh;
    user-select: none;
    position: relative;
  }
  h1 {
    margin: 1rem;
    text-align: center;
  }
  #prompt {
    font-size: 1.5rem;
    margin: 0 auto 1rem auto;
    text-align: center;
  }
  #feedback {
    height: 2em;
    font-size: 1.3rem;
    text-align: center;
    margin-top: 0.5rem;
  }
  #btnSpeak {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.5rem;
    padding: 0.5rem 1.5rem;
    border: none;
    border-radius: 8px;
    background: #0a84ff;
    color: white;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s ease;
    z-index: 1000;
  }
  #btnSpeak.listening {
    background: #ff3b30;
  }
  .floating {
    position: absolute;
    font-weight: 900;
    font-size: 8rem;
    user-select: none;
    pointer-events: none;
    color: #0af;
    will-change: transform, opacity;
  }
  @keyframes flyAway {
    to {
      transform: translate(var(--dx), var(--dy)) rotate(var(--dr));
      opacity: 0;
    }
  }
</style>
</head>
<body>

<h1>Игра буква-номер (английский алфавит) с голосом (числа по-русски)</h1>
<div id="prompt">Загрузка...</div>
<div id="feedback"></div>
<button id="btnSpeak">Запустить распознавание</button>

<audio id="shotSound" src="https://actions.google.com/sounds/v1/weapons/shotgun_fire.ogg" preload="auto"></audio>

<script>
(() => {
  const promptEl = document.getElementById('prompt');
  const feedbackEl = document.getElementById('feedback');
  const btnSpeak = document.getElementById('btnSpeak');
  const shotSound = document.getElementById('shotSound');

  // Английский алфавит A-Z
  const letters = Array.from({length:26}, (_,i) => String.fromCharCode(65 + i)); // A-Z

  // Русские числительные 1-26 + цифры
  const russianNumbers = {
    'ОДИН':1, 'ДВА':2, 'ТРИ':3, 'ЧЕТЫРЕ':4, 'ПЯТЬ':5, 'ШЕСТЬ':6, 'СЕМЬ':7, 'ВОСЕМЬ':8, 'ВОСЕМЬЬ':8, 'ВОСЕМЬ':8,
    'ВОСЕМЬ':8, 'ВОСЕМЬ':8, 'ВОСЕМЬ':8, 'ВОСЕМЬ':8, 'ВОСЕМЬ':8,
    'ВОСЕМЬ':8, 'ВОСЕМЬ':8, 'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
    'ВОСЕМЬ':8,
  }; // исправим ниже

  // Исправим полный словарь чисел по-русски 1-26:
  const russianNumWords = {
    'ОДИН':1, 'ДВА':2, 'ТРИ':3, 'ЧЕТЫРЕ':4, 'ПЯТЬ':5, 'ШЕСТЬ':6, 'СЕМЬ':7, 'ВОСЕМЬ':8, 'ДЕВЯТЬ':9, 'ДЕСЯТЬ':10,
    'ОДИННАДЦАТЬ':11, 'ДВЕНАДЦАТЬ':12, 'ТРИНАДЦАТЬ':13, 'ЧЕТЫРНАДЦАТЬ':14, 'ПЯТНАДЦАТЬ':15, 'ШЕСТНАДЦАТЬ':16,
    'СЕМНАДЦАТЬ':17, 'ВОСЕМНАДЦАТЬ':18, 'ДЕВЯТНАДЦАТЬ':19, 'ДВАДЦАТЬ':20,
    'ДВАДЦАТЬ ОДИН':21, 'ДВАДЦАТЬ ОДНО':21, 'ДВАДЦАТЬ ДВА':22, 'ДВАДЦАТЬ ТРИ':23, 'ДВАДЦАТЬ ЧЕТЫРЕ':24,
    'ДВАДЦАТЬ ПЯТЬ':25, 'ДВАДЦАТЬ ШЕСТЬ':26
  };

  // Для удобства добавим функцию для поиска числа в распознанном тексте (учитывая, что распознаватель может вернуть несколько слов)
  function findRussianNumber(text) {
    text = text.toUpperCase().trim();

    // Сначала проверим, есть ли цифра 1-26 в тексте
    let digitMatch = text.match(/\b([1-9]|1[0-9]|2[0-6])\b/);
    if (digitMatch) return parseInt(digitMatch[1],10);

    // Проверим длинные числительные (составные)
    // Например "двадцать один"
    for (const [key, val] of Object.entries(russianNumWords)) {
      // Сравним без знаков препинания, с пробелами
      if (text === key) return val;
      // если текст начинается с ключа (например, "двадцать один что-то")
      if (text.startsWith(key + ' ')) return val;
    }
    return null;
  }

  // Русские варианты произношения английских букв (транскрипция), для сопоставления с английскими буквами
  const russianLetterMap = {
    'ЭЙ': 'A',
    'БИ': 'B',
    'СИ': 'C',
    'ДИ': 'D',
    'И': 'E',
    'И-Ф': 'F',
    'ДЖИ': 'G',
    'ЭЙЧ': 'H',
    'АЙ': 'I',
    'ДЖЕЙ': 'J',
    'КЕЙ': 'K',
    'ЭЛ': 'L',
    'ЭМ': 'M',
    'ЭН': 'N',
    'ОУ': 'O',
    'ПИ': 'P',
    'КЬЮ': 'Q',
    'АР': 'R',
    'ЭС': 'S',
    'ТИ': 'T',
    'Ю': 'U',
    'ВИ': 'V',
    'ДАБЛЬ-Ю': 'W',
    'ЭКС': 'X',
    'УАЙ': 'Y',
    'ЗИ': 'Z',
    'ЗЕД': 'Z',
    'ЗИ': 'Z',
  };

  // Парсим ответ — либо число (русское), либо буква (русская транскрипция)
  function parseAnswer(text) {
    text = text.trim().toUpperCase();

    // Попробуем найти число по-русски
    const num = findRussianNumber(text);
    if (num !== null && num >= 1 && num <= 26) {
      return {type:'number', value: num};
    }

    // Попробуем найти букву по русской транскрипции
    // Иногда распознаватель может возвращать слова с пробелами, возьмём первое слово
    let firstWord = text.split(/\s+/)[0];
    if (russianLetterMap.hasOwnProperty(firstWord)) {
      return {type:'letter', value: russianLetterMap[firstWord]};
    }

    // Если это одиночная английская буква (A-Z)
    if (text.length === 1 && letters.includes(text)) {
      return {type:'letter', value: text};
    }

    return null;
  }

  // SpeechRecognition setup
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert('Ваш браузер не поддерживает распознавание речи. Используйте Chrome или Edge.');
    btnSpeak.disabled = true;
    promptEl.textContent = 'Распознавание речи не поддерживается.';
    return;
  }
  const recognition = new SpeechRecognition();
  recognition.lang = 'ru-RU'; // Русский язык для распознавания чисел и букв русскими словами
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.continuous = true;

  // Перемешивание массива (Fisher-Yates)
  function shuffle(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex !== 0) {
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex--;
      [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
    }
    return array;
  }

  let shuffledIndexes = [];
  let currentRound = 0;
  let step = 0; // 0: показываем букву, ожидаем число; 1: показываем число, ожидаем букву

  function resetGameOrder() {
    shuffledIndexes = shuffle([...Array(letters.length).keys()]);
    currentRound = 0;
  }

  function showFloating(text) {
    const floatEl = document.createElement('div');
    floatEl.className = 'floating';
    floatEl.textContent = text;

    const pad = 120;
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const x = Math.random() * (vw - pad*2) + pad;
    const y = Math.random() * (vh - pad*2) + pad;

    floatEl.style.left = `${x}px`;
    floatEl.style.top = `${y}px`;

    document.body.appendChild(floatEl);

    return floatEl;
  }

  function animateFlyAway(el) {
    const dx = (Math.random() - 0.5) * 400 + 'px';
    const dy = (Math.random() - 0.5) * 400 + 'px';
    const dr = (Math.random() - 0.5) * 720 + 'deg';

    el.style.setProperty('--dx', dx);
    el.style.setProperty('--dy', dy);
    el.style.setProperty('--dr', dr);

    el.style.animation = 'flyAway 1.2s forwards ease-out';

    el.addEventListener('animationend', () => {
      if (el.parentNode) el.parentNode.removeChild(el);
    });
  }

  function playShot() {
    shotSound.currentTime = 0;
    shotSound.play();
  }

  let currentFloatingEl = null;

  function showCurrent() {
    if (currentFloatingEl) {
      currentFloatingEl.remove();
      currentFloatingEl = null;
    }
    if (currentRound >= shuffledIndexes.length) {
      promptEl.textContent = 'Игра завершена! Перезапуск через 3 секунды...';
      feedbackEl.textContent = '';
      setTimeout(() => {
        resetGameOrder();
        step = 0;
        showCurrent();
      }, 3000);
      return;
    }
    const idx = shuffledIndexes[currentRound];
    if (step === 0) {
      promptEl.textContent = "Назовите порядковый номер показанной буквы (от 1 до 26)";
      currentFloatingEl = showFloating(letters[idx]);
    } else {
      promptEl.textContent = "Назовите букву, соответствующую показанному номеру";
      currentFloatingEl = showFloating((idx + 1).toString());
    }
  }

  recognition.onresult = (event) => {
    const transcript = event.results[event.results.length - 1][0].transcript;
    const parsed = parseAnswer(transcript);

    if (!parsed) {
      feedbackEl.textContent = `Не распознано: "${transcript.trim()}"`;
      return;
    }

    const idx = shuffledIndexes[currentRound];
    if (step === 0 && parsed.type === 'number') {
      if (parsed.value === idx + 1) {
        feedbackEl.textContent = `Верно! Буква ${letters[idx]} — это номер ${parsed.value}`;
        playShot();
        animateFlyAway(currentFloatingEl);
        currentFloatingEl = null;
        step = 1;
      } else {
        feedbackEl.textContent = `Неверный номер "${parsed.value}". Попробуйте ещё раз.`;
      }
    } else if (step === 1 && parsed.type === 'letter') {
      if (parsed.value === letters[idx]) {
        feedbackEl.textContent = `Верно! Номер ${idx+1} — это буква ${parsed.value}`;
        playShot();
        animateFlyAway(currentFloatingEl);
        currentFloatingEl = null;
        currentRound++;
        step = 0;
      } else {
        feedbackEl.textContent = `Неверная буква "${parsed.value}". Попробуйте ещё раз.`;
      }
    } else {
      feedbackEl.textContent = `Ожидался ${step === 0 ? 'номер' : 'буква'}, но получено ${parsed.type}. Попробуйте ещё раз.`;
    }

    if (!currentFloatingEl) {
      setTimeout(() => {
        showCurrent();
      }, 1300);
    }
  };

  recognition.onerror = (e) => {
    feedbackEl.textContent = 'Ошибка распознавания: ' + e.error;
  };
  recognition.onend = () => {
    if (btnSpeak.classList.contains('listening')) {
      recognition.start(); // перезапуск для непрерывного прослушивания
    }
  };

  btnSpeak.addEventListener('click', () => {
    if (btnSpeak.classList.contains('listening')) {
      recognition.stop();
      btnSpeak.classList.remove('listening');
      btnSpeak.textContent = 'Запустить распознавание';
      promptEl.textContent = 'Распознавание остановлено.';
    } else {
      recognition.start();
      btnSpeak.classList.add('listening');
      btnSpeak.textContent = 'Остановить распознавание';
      feedbackEl.textContent = '';
      if (!currentFloatingEl) showCurrent();
    }
  });

  resetGameOrder();
  promptEl.textContent = 'Нажмите "Запустить распознавание" и говорите ответы чётко.';
})();
</script>

</body>
</html>
